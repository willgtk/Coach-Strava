import os
import requests
from datetime import datetime, timedelta
from dotenv import load_dotenv, set_key
import telebot
from google import genai
from google.genai import types
from stravalib.client import Client

# 1. Carrega as vari√°veis
env_path = os.path.join(os.path.dirname(__file__), '.env')
load_dotenv(env_path)

STRAVA_CLIENT_ID = os.getenv('STRAVA_CLIENT_ID')
STRAVA_CLIENT_SECRET = os.getenv('STRAVA_CLIENT_SECRET')
STRAVA_TOKEN = os.getenv('STRAVA_TOKEN')
STRAVA_REFRESH_TOKEN = os.getenv('STRAVA_REFRESH_TOKEN')
GOOGLE_API_KEY = os.getenv('GOOGLE_API_KEY')
TELEGRAM_TOKEN = os.getenv('TELEGRAM_TOKEN')

# 2. Inicializa as APIs
bot = telebot.TeleBot(TELEGRAM_TOKEN)
client_ai = genai.Client(api_key=GOOGLE_API_KEY)
client_strava = Client(access_token=STRAVA_TOKEN)

instrucoes_coach = """
Voc√™ √© um treinador de Mountain Bike de alta performance. Seu aluno usa uma Oggi Agile Sport com SRAM GX.
Voc√™ deve agir como um coach: analise dados, sugira treinos, sugerir rotas, quebra de segmentos, puxe a orelha quando necess√°rio e seja motivador. Seja um bom professor, mas tambem exigente!
Sempre responda de forma concisa e direta, ideal para leitura r√°pida no Telegram. Seja sarc√°stico quando o desempenho for ruim, mas sempre com a inten√ß√£o de motivar a melhorar.
Se o aluno pedir sugest√£o de treino, sugira um treino espec√≠fico para MTB, com foco em resist√™ncia, for√ßa ou t√©cnica, dependendo do hist√≥rico recente dele. Se pedir an√°lise de pedal, seja direto e destaque pontos de melhoria.
"""

chat_session = client_ai.chats.create(
    model='gemini-2.5-flash',
    config=types.GenerateContentConfig(system_instruction=instrucoes_coach)
)

# ==========================================
# üõ°Ô∏è NOVO: FUN√á√ÉO DE RENOVA√á√ÉO DE TOKEN
# ==========================================
def renovar_token_strava():
    print("üîÑ Token expirado! Iniciando renova√ß√£o autom√°tica...")
    url = "https://www.strava.com/oauth/token"
    payload = {
        'client_id': STRAVA_CLIENT_ID,
        'client_secret': STRAVA_CLIENT_SECRET,
        'grant_type': 'refresh_token',
        'refresh_token': os.getenv('STRAVA_REFRESH_TOKEN') # Puxa sempre o mais atual
    }
    
    response = requests.post(url, data=payload)
    
    if response.status_code == 200:
        dados = response.json()
        novo_access = dados['access_token']
        novo_refresh = dados['refresh_token']
        
        # 1. Atualiza o arquivo .env
        set_key(env_path, 'STRAVA_TOKEN', novo_access)
        set_key(env_path, 'STRAVA_REFRESH_TOKEN', novo_refresh)
        
        # 2. Atualiza a mem√≥ria do Python
        os.environ['STRAVA_TOKEN'] = novo_access
        os.environ['STRAVA_REFRESH_TOKEN'] = novo_refresh
        
        # 3. Atualiza o cliente do Stravalib
        client_strava.access_token = novo_access
        
        print("‚úÖ Token renovado e injetado com sucesso!")
        return True
    else:
        print(f"‚ùå Falha cr√≠tica ao renovar token: {response.text}")
        return False

# ==========================================
# L√ìGICA DO STRAVA COM TRATAMENTO DE ERRO
# ==========================================
def obter_resumo_semana():
    uma_semana_atras = datetime.now() - timedelta(days=7)
    
    try:
        # Tenta puxar os dados
        atividades = client_strava.get_activities(after=uma_semana_atras)
        atividades_lista = list(atividades) # For√ßa a execu√ß√£o para testar o token
        
    except Exception as e:
        # Se der erro de autoriza√ß√£o (401), tenta renovar o token
        if "401" in str(e) or "unauthorized" in str(e).lower():
            if renovar_token_strava():
                # Tenta de novo ap√≥s renovar
                atividades = client_strava.get_activities(after=uma_semana_atras)
                atividades_lista = list(atividades)
            else:
                return "Erro cr√≠tico: N√£o consegui renovar o acesso ao Strava."
        else:
            return f"Erro desconhecido no Strava: {e}"

    total_km = 0
    total_elevacao = 0
    qtd_pedais = 0
    
    for act in atividades_lista:
        if act.type in ["Ride", "VirtualRide", "MountainBikeRide"]:
            total_km += float(act.distance) / 1000
            total_elevacao += float(act.total_elevation_gain)
            qtd_pedais += 1
            
    if qtd_pedais == 0:
        return "Nenhum pedal registrado nos √∫ltimos 7 dias."
        
    return f"Resumo dos √∫ltimos 7 dias: {qtd_pedais} pedais, {total_km:.1f} km rodados, {total_elevacao:.0f}m de eleva√ß√£o acumulada."

# ==========================================
# ROTAS DO TELEGRAM
# ==========================================
@bot.message_handler(commands=['start', 'help'])
def send_welcome(message):
    texto = "Fala, ciclista! Sou seu Coach de MTB com IA. üöµ‚Äç‚ôÇÔ∏è\n\nComandos:\n/semana - Analisa os √∫ltimos 7 dias."
    bot.reply_to(message, texto)

@bot.message_handler(commands=['semana'])
def analisar_semana(message):
    bot.reply_to(message, "Buscando seus dados no Strava... ‚è≥")
    dados = obter_resumo_semana()
    
    if "Erro" in dados:
        bot.reply_to(message, dados)
        return
        
    prompt = f"Analise meu volume de treino desta semana e me sugira o pr√≥ximo treino: {dados}"
    resposta_ia = chat_session.send_message(prompt)
    bot.reply_to(message, resposta_ia.text)

@bot.message_handler(func=lambda message: True)
def conversa_livre(message):
    bot.send_chat_action(message.chat.id, 'typing')
    resposta_ia = chat_session.send_message(message.text)
    bot.reply_to(message, resposta_ia.text)

print("ü§ñ Coach de MTB online e blindado! Pressione Ctrl+C para parar.")
bot.infinity_polling()